// File: apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Vendor {
  id          String    @id @default(cuid())
  name        String    @unique // Unique name is crucial for connectOrCreate
  address     String?
  taxId       String?
  partyNumber String?
  invoices    Invoice[]
  createdAt   DateTime  @default(now())
}

model Customer {
  id        String    @id @default(cuid())
  name      String    @unique // Unique name is crucial
  address   String?
  invoices  Invoice[]
  createdAt DateTime  @default(now())
}

model Invoice {
  id             String    @id @default(cuid())
  documentId     String?   @unique // From the top-level _id
  status         String
  invoiceNumber  String
  invoiceDate    DateTime
  deliveryDate   DateTime?
  subTotal       Decimal? // <-- FIXED: Use Decimal for money
  totalTax       Decimal? // <-- FIXED: Use Decimal for money
  invoiceTotal   Decimal // <-- FIXED: Use Decimal for money
  currencySymbol String?
  documentType   String?
  createdAt      DateTime  @default(now())

  vendorId String
  vendor   Vendor @relation(fields: [vendorId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // FIXED: 1-to-1 relationship
  payment Payment?

  lineItems LineItem[]

  @@index([vendorId])
  @@index([customerId])
  @@index([invoiceDate])
}

model Payment {
  id                String    @id @default(cuid())
  dueDate           DateTime?
  paymentTerms      String?
  bankAccountNumber String?

  // FIXED: 1-to-1 relationship with Invoice
  invoiceId String  @unique
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model LineItem {
  id          String   @id @default(cuid())
  description String?
  quantity    Float? // Float is OK for quantity
  unitPrice   Decimal? // <-- FIXED: Use Decimal for money
  totalPrice  Decimal? // <-- FIXED: Use Decimal for money
  buKey       String? // From BUSchluessel

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // FIXED: Normalized categories
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  @@index([invoiceId])
  @@index([categoryId])
}

// FIXED: Added missing Category table
model Category {
  id        String     @id @default(cuid())
  code      String     @unique // This will be the "Sachkonto" value
  lineItems LineItem[]
}

model ChatHistory {
  id        String   @id @default(cuid())
  question  String
  sql       String
  createdAt DateTime @default(now())
}
